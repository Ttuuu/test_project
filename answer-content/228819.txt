<div class="s-prose s-prose__disable-spoiler-hover js-post-body" itemprop="text">
<p>Use a <code>CyclicBarrier</code> with only the neural-net thread waiting, and decrement it after adding an item to the queue (which should probably be a <code>ConcurrentLinkedQueue</code>). Then it will automatically trigger after every 32 entries, at which point it should pop exactly 32 entries from the head of the queue (an operation that won't block if it's the queue's only consumer).</p>

<p>You can probably eliminate the <code>synchronized</code> block in <code>process</code> if you also replace both <code>HashMap</code> instances with <code>ConcurrentHashMap</code>. This will improve performance when <code>process</code> is called from more than a small constant number of threads (probably on the order of 2 or 3).</p>
    </div>